{% extends 'dashboard/base_dashboard.html' %}
{% load format_helpers %}

{% block dashboard_content %}

<div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
  <div>
    <h2 class="h3 fw-bold mb-0">Reserva #{{ reserva.codigo }}</h2>
    <p class="text-muted mb-0">Gerencie as informações e o status desta reserva.</p>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <a href="{% url 'editar_reserva' reserva_id=reserva.id %}" class="btn btn-warning" title="Editar Reserva"><i class="bi bi-pencil-fill"></i><span class="d-none d-sm-inline ms-1">Editar</span></a>
    
    <a href="https://wa.me/{{ reserva.cliente.telefone|format_whatsapp_number }}?text={% filter urlencode %}Olá, *{{ reserva.cliente.nome }}*! Tudo bem?

Aqui é da *Vá com John*. Segue a confirmação da sua reserva:

*CONFIRMAÇÃO DE RESERVA*

*Localizador:* #{{ reserva.codigo }}
*Data:* {{ reserva.data_agendamento|date:"d/m/Y" }}
*Horário:* {{ reserva.data_agendamento|date:"H:i" }}

{% if reserva.tipo == 'passeio' %}
*Passeio:* {{ reserva.praia_destino.nome }}
*Local Saída:* {{ reserva.local_partida }}
{% else %}
*Transfer:* {{ reserva.local_partida }} para {{ reserva.local_chegada }}
*Voo:* {{ reserva.informacoes_voo|default:"Não informado" }}
{% endif %}

*Qtd Pessoas:* {{ reserva.numero_passageiros }}
*Valor Total:* R$ {{ reserva.valor|floatformat:2 }}

{% if reserva.guia %}
*Guia:* {{ reserva.guia.nome }} - {{ reserva.guia.modelo_carro }}
{% endif %}

Qualquer dúvida, estou à disposição!
Acesse: www.vacomjohn.com.br{% endfilter %}" 
       target="_blank" class="btn btn-success" title="Confirmar via WhatsApp">
       <i class="bi bi-whatsapp"></i><span class="d-none d-sm-inline ms-1">Confirmar (WhatsApp)</span>
    </a>
    <a href="{% url 'gerar_recibo_pdf' reserva_id=reserva.id %}" target="_blank" class="btn btn-info text-white" title="Gerar Voucher"><i class="bi bi-file-earmark-text"></i><span class="d-none d-sm-inline ms-1">Voucher</span></a>
    <a href="{% url 'gerar_recibo_financeiro' reserva_id=reserva.id %}" target="_blank" class="btn btn-success text-white" title="Gerar Recibo Pagamento"><i class="bi bi-cash-stack"></i><span class="d-none d-sm-inline ms-1">Recibo</span></a>
    <a href="{% url 'painel' %}" class="btn btn-secondary" title="Voltar para a Lista"><i class="bi bi-arrow-left-circle"></i><span class="d-none d-sm-inline ms-1">Voltar</span></a>
  </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body d-flex align-items-center">
            <div class="fs-2 text-primary me-3"><i class="bi bi-person-circle"></i></div>
            <div>
              <h6 class="card-subtitle mb-1 text-muted">Cliente</h6>
              <h5 class="card-title mb-0 fw-bold">{{ reserva.cliente.nome }} {{ reserva.cliente.sobrenome }}</h5>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body d-flex align-items-center">
            <div class="fs-2 text-success me-3"><i class="bi bi-calendar-check"></i></div>
            <div>
              <h6 class="card-subtitle mb-1 text-muted">Agendado para</h6>
              <h5 class="card-title mb-0 fw-bold">{{ reserva.data_agendamento|date:"d/m/Y, H:i" }}</h5>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body d-flex align-items-center">
            <div class="fs-2 text-warning me-3"><i class="bi bi-info-circle"></i></div>
            <div>
              <h6 class="card-subtitle mb-1 text-muted">Status Atual</h6>
              {% if reserva.status == 'pendente' %}<span class="badge bg-warning text-dark fs-6">{{ reserva.get_status_display }}</span>{% endif %}
              {% if reserva.status == 'confirmado' %}<span class="badge bg-success fs-6">{{ reserva.get_status_display }}</span>{% endif %}
              {% if reserva.status == 'concluido' %}<span class="badge bg-secondary fs-6">{{ reserva.get_status_display }}</span>{% endif %}
              {% if reserva.status == 'cancelado' %}<span class="badge bg-danger fs-6">{{ reserva.get_status_display }}</span>{% endif %}
            </div>
          </div>
        </div>
      </div>
</div>

<div class="card shadow-sm border-0">
  <div class="card-header bg-white">
    <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation"><button class="nav-link active" id="reserva-tab" data-bs-toggle="tab" data-bs-target="#reserva-tab-pane" type="button" role="tab">Detalhes da Reserva</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" id="guia-tab" data-bs-toggle="tab" data-bs-target="#guia-tab-pane" type="button" role="tab">Guia Responsável</button></li>
      {% if reserva.parceiro %}
      <li class="nav-item" role="presentation"><button class="nav-link text-danger fw-bold" id="parceiro-tab" data-bs-toggle="tab" data-bs-target="#parceiro-tab-pane" type="button" role="tab"><i class="bi bi-piggy-bank me-1"></i> Comissão</button></li>
      {% endif %}
    </ul>
  </div>
  <div class="card-body">
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="reserva-tab-pane" role="tabpanel">
        <div class="row">
          <div class="col-md-6 border-end">
            <h5 class="mb-3 text-primary fw-bold">Informações do Serviço</h5>
            <dl class="row">
              <dt class="col-sm-5">Tipo de Serviço:</dt><dd class="col-sm-7">{{ reserva.get_tipo_display }}</dd>
              <dt class="col-sm-5">Valor Total:</dt><dd class="col-sm-7 fw-bold text-success">R$ {{ reserva.valor|floatformat:2 }}</dd>
              <dt class="col-sm-5">Nº de Passageiros:</dt><dd class="col-sm-7">{{ reserva.numero_passageiros }}</dd>
              {% if reserva.tipo == 'passeio' %}
                <dt class="col-sm-5">Passeio:</dt><dd class="col-sm-7">{{ reserva.praia_destino.nome }}</dd>
                <dt class="col-sm-5">Partida:</dt><dd class="col-sm-7">{{ reserva.local_partida }}</dd>
              {% else %}
                <dt class="col-sm-5">Trajeto:</dt><dd class="col-sm-7">{{ reserva.local_partida }} → {{ reserva.local_chegada }}</dd>
                <dt class="col-sm-5">Voo:</dt><dd class="col-sm-7">{{ reserva.informacoes_voo|default:"Não informado" }}</dd>
              {% endif %}
              <dt class="col-sm-5">Venda feita por:</dt>
              <dd class="col-sm-7">
                  {% if reserva.parceiro %}
                    <span class="badge bg-info text-dark">Parceiro: {{ reserva.parceiro.usuario.first_name }}</span>
                  {% else %}
                    <span class="badge bg-light text-dark">Site Direto</span>
                  {% endif %}
              </dd>
            </dl>
          </div>
          <div class="col-md-6">
            <h5 class="mb-3 text-primary fw-bold">Informações do Cliente</h5>
            <dl class="row">
              <dt class="col-sm-4">Nome:</dt><dd class="col-sm-8">{{ reserva.cliente.nome }} {{ reserva.cliente.sobrenome }}</dd>
              <dt class="col-sm-4">Email:</dt><dd class="col-sm-8">{{ reserva.cliente.email }}</dd>
              <dt class="col-sm-4">Telefone:</dt><dd class="col-sm-8">{{ reserva.cliente.telefone }}</dd>
            </dl>
          </div>
        </div>
      </div>
      
      <div class="tab-pane fade" id="guia-tab-pane" role="tabpanel">
        <h5 class="mb-3 fw-bold">Atribuir Guia Responsável</h5>
        {% if reserva.guia %}
            <div class="alert alert-info d-flex align-items-center">
                <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                <div>Guia atual: <strong>{{ reserva.guia.nome }}</strong> ({{ reserva.guia.modelo_carro }})</div>
            </div>
        {% endif %}
        <form method="POST" action="{% url 'detalhe_reserva' reserva.id %}">
          {% csrf_token %}
          <div class="row align-items-end g-3">
            <div class="col-md-8">
              <label for="guia" class="form-label small fw-bold">Selecione o Guia:</label>
              <select name="guia" id="guia" class="form-select bg-light">
                <option value="">-- Nenhum --</option>
                {% for g in guias %}
                    <option value="{{ g.id }}" {% if reserva.guia.id == g.id %}selected{% endif %}>{{ g.nome }} - {{ g.modelo_carro }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <button type="submit" class="btn btn-primary w-100">Atualizar Guia</button>
            </div>
          </div>
        </form>
      </div>

      {% if reserva.parceiro %}
      <div class="tab-pane fade" id="parceiro-tab-pane" role="tabpanel">
        <div class="row">
            <div class="col-md-7">
                <div class="card border-warning shadow-sm">
                    <div class="card-body">
                        <h5 class="fw-bold text-warning mb-4"><i class="bi bi-wallet2 me-2"></i>Financeiro do Parceiro</h5>
                        
                        <div class="mb-3 d-flex justify-content-between border-bottom pb-2">
                            <span>Parceiro Indicador:</span>
                            <span class="fw-bold">{{ reserva.parceiro.usuario.first_name }}</span>
                        </div>
                        <div class="mb-3 d-flex justify-content-between border-bottom pb-2">
                            <span>Valor da Comissão:</span>
                            <span class="fw-bold text-success fs-5">R$ {{ reserva.valor_comissao|floatformat:2 }}</span>
                        </div>
                        <div class="mb-3 d-flex justify-content-between border-bottom pb-2">
                            <span>Chave Pix para Pagamento:</span>
                            <span class="badge bg-light text-dark fs-6">{{ reserva.parceiro.chave_pix|default:"NÃO CADASTRADA" }}</span>
                        </div>
                        <div class="mb-4 d-flex justify-content-between">
                            <span>Status do Pagamento:</span>
                            {% if reserva.status_pagamento_comissao == 'pago' %}
                                <span class="badge bg-success">PAGO</span>
                            {% else %}
                                <span class="badge bg-danger">PENDENTE</span>
                            {% endif %}
                        </div>

                        {% if reserva.status_pagamento_comissao == 'pendente' %}
                        <form method="POST" action="{% url 'atualizar_pagamento_comissao' reserva.id %}">
                            {% csrf_token %}
                            <div class="d-grid">
                                <button type="submit" class="btn btn-warning fw-bold">
                                    <i class="bi bi-check-all me-1"></i> MARCAR COMO PIX ENVIADO
                                </button>
                            </div>
                        </form>
                        {% else %}
                            <div class="alert alert-success text-center mb-0">
                                <i class="bi bi-check-circle-fill me-2"></i> Esta comissão já foi paga.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="alert alert-secondary small">
                    <h6 class="fw-bold"><i class="bi bi-info-circle me-1"></i> Regras de Comissão:</h6>
                    <ul class="mb-0">
                        <li><strong>Transfer:</strong> Valor fixo de R$ 20,00.</li>
                        <li><strong>Passeios:</strong> 10% sobre o valor total.</li>
                        <li>A comissão só fica "Disponível" para o parceiro quando o status da reserva mudar para <strong>Concluído</strong>.</li>
                    </ul>
                </div>
            </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>

  <div class="card-footer bg-light text-end py-3">
    <form method="POST" class="d-inline">
      {% csrf_token %}
      {% if reserva.status == 'pendente' %}
        <button type="submit" name="status" value="confirmado" class="btn btn-success px-4 rounded-pill shadow-sm"><i class="bi bi-check-circle me-1"></i> Confirmar Reserva</button>
      {% endif %}
      {% if reserva.status == 'confirmado' %}
        <button type="submit" name="status" value="concluido" class="btn btn-info text-white px-4 rounded-pill shadow-sm"><i class="bi bi-flag-fill me-1"></i> Marcar como Concluída</button>
      {% endif %}
      {% if reserva.status != 'cancelado' and reserva.status != 'concluido' %}
        <button type="submit" name="status" value="cancelado" class="btn btn-outline-danger px-4 rounded-pill ms-2"><i class="bi bi-x-circle me-1"></i> Cancelar Reserva</button>
      {% endif %}
    </form>
  </div>
</div>
{% endblock %}